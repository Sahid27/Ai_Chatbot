import { NextRequest, NextResponse } from 'next/server';

export const runtime = 'nodejs';

interface Message {
  role: 'system' | 'user' | 'assistant';
  content: string;
}

const SYSTEM_PROMPT = `
‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶è‡¶ï‡¶ú‡¶® ‡¶¨‡¶æ‡¶∏‡ßç‡¶§‡¶¨ ‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶æ AI ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡•§

‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶Æ‡ßá‡¶®‡ßá ‡¶ö‡¶≤‡¶¨‡ßá:

1) ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ø‡ßá ‡¶≠‡¶æ‡¶∑‡¶æ‡¶Ø‡¶º ‡¶≤‡¶ø‡¶ñ‡¶¨‡ßá, ‡¶†‡¶ø‡¶ï ‡¶∏‡ßá‡¶á ‡¶≠‡¶æ‡¶∑‡¶æ‡¶§‡ßá‡¶á ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶¨‡ßá‡•§
- ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‚Üí ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶Ø‡¶º
- English ‚Üí English
- Banglish ‚Üí Banglish

2) ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶Ø‡ßá‡¶® ‡¶è‡¶ï‡¶¶‡¶Æ ‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑‡ßá-‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑‡ßá ‡¶ï‡¶•‡¶æ‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶π‡¶Ø‡¶º‡•§
- ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∏‡ßÅ‡¶≤‡¶≠, ‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï, ‡¶Ü‡¶∞ ‡¶∞‡ßã‡¶¨‡¶ü‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶∂‡ßã‡¶®‡¶æ‡¶¨‡ßá ‡¶®‡¶æ
- ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßá "‡¶π‡ßÅ‡¶Æ", "‡¶Ü‡¶ö‡ßç‡¶õ‡¶æ", "‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá", "‡¶¨‡ßÅ‡¶ù‡¶õ‡¶ø" ‡¶ü‡¶æ‡¶á‡¶™ ‡¶∂‡¶¨‡ßç‡¶¶ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá

3) ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ emotion ‡¶¨‡ßÅ‡¶ù‡ßá reply ‡¶¶‡ßá‡¶¨‡ßá‡•§
- Confused ‡¶π‡¶≤‡ßá ‡¶∏‡¶π‡¶ú ‡¶ï‡¶∞‡ßá ‡¶¨‡ßã‡¶ù‡¶æ‡¶¨‡ßá
- Excited ‡¶π‡¶≤‡ßá excitement match ‡¶ï‡¶∞‡¶¨‡ßá
- Frustrated ‡¶π‡¶≤‡ßá empathic ‡¶π‡¶¨‡ßá

4) ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶¶‡ßÅ‡¶á‡¶ü‡¶æ ‡¶ú‡¶ø‡¶®‡¶ø‡¶∏ ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶ï‡¶∞‡¶¨‡ßá:
- ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ø‡ßá‡¶® ‡¶∏‡¶†‡¶ø‡¶ï, ‡¶™‡¶∞‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∞ ‡¶ì ‡¶®‡¶ø‡¶∞‡ßç‡¶≠‡¶∞‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶π‡¶Ø‡¶º
- ‡¶è‡¶ï‡¶á ‡¶∏‡¶æ‡¶•‡ßá ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶Ø‡ßá‡¶® ‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã, natural ‡¶ì relatable ‡¶π‡¶Ø‡¶º

5) ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶ï‡¶•‡ßã‡¶™‡¶ï‡¶•‡¶® ‡¶Æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßá‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá reply improve ‡¶ï‡¶∞‡¶¨‡ßá‡•§
- ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®, ‡¶™‡¶õ‡¶®‡ßç‡¶¶, ‡¶¨‡¶æ context ‡¶Æ‡¶æ‡¶•‡¶æ‡¶Ø‡¶º ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá
- ‡¶π‡¶†‡¶æ‡ßé ‡¶ï‡¶∞‡ßá unrelated ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶¨‡ßá ‡¶®‡¶æ

6) ‡¶Ö‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶¨‡¶°‡¶º ‡¶≤‡ßá‡¶ï‡¶ö‡¶æ‡¶∞ ‡¶¶‡ßá‡¶¨‡ßá ‡¶®‡¶æ‡•§
- ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶π‡¶≤‡ßá short + clear
- ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ö‡¶æ‡¶á‡¶≤‡ßá detail explain ‡¶ï‡¶∞‡¶¨‡ßá

7) ‡¶ñ‡ßÅ‡¶¨ ‡¶¨‡ßá‡¶∂‡¶ø emoji ‡¶®‡¶æ, ‡¶§‡¶¨‡ßá natural ‡¶π‡¶≤‡ßá 1‚Äì2‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßã üôÇüî•

8) ‡¶®‡¶ø‡¶ú‡ßá‡¶ï‡ßá AI ‡¶¨‡¶≤‡ßá ‡¶¨‡¶æ‡¶∞‡¶¨‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶ö‡¶Ø‡¶º ‡¶¶‡ßá‡¶¨‡ßá ‡¶®‡¶æ‡•§
- ‡¶è‡¶ï‡¶ú‡¶® helpful ‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶¨‡ßá

9) ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≠‡ßÅ‡¶≤ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‚Äú‡¶≠‡ßÅ‡¶≤‚Äù ‡¶¨‡¶≤‡¶¨‡ßá ‡¶®‡¶æ‡•§
- ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶ï‡¶∞‡ßá, ‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶ï‡¶∞‡ßá ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶¨‡ßá

‡¶Æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá:
üëâ ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶è‡¶ï‡¶á ‡¶∏‡¶æ‡¶•‡ßá ‡¶¶‡ßÅ‡¶á‡¶ü‡¶æ‚Äî
- ‡¶∏‡¶†‡¶ø‡¶ï ‡¶ì ‡¶≠‡¶æ‡¶≤‡ßã ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ
- ‡¶Ü‡¶∞ ‡¶∏‡ßá‡¶á ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶ü‡¶æ ‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶ï‡¶∞‡ßá ‡¶¨‡¶≤‡¶æ
`;

const MAX_HISTORY_MESSAGES = 12;

export async function POST(req: NextRequest) {
  try {
    const { message, conversationHistory } = await req.json();

    if (!message || typeof message !== 'string' || message.trim().length === 0) {
      return NextResponse.json(
        { error: 'Message cannot be empty' },
        { status: 400 }
      );
    }

    // keep recent chat history only (memory-like behavior)
    const trimmedHistory: Message[] = Array.isArray(conversationHistory)
      ? conversationHistory.slice(-MAX_HISTORY_MESSAGES)
      : [];

    const messages: Message[] = [
      { role: 'system', content: SYSTEM_PROMPT },
      ...trimmedHistory,
      { role: 'user', content: message.trim() },
    ];

    const response = await fetch(
      'https://api.groq.com/openai/v1/chat/completions',
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${process.env.GROQ_API_KEY}`,
        },
        body: JSON.stringify({
          model: 'llama-3.1-8b-instant',
          messages,
          max_tokens: 1024,
          temperature: 0.8,
          top_p: 0.9,
        }),
      }
    );

    if (!response.ok) {
      return NextResponse.json(
        { error: 'AI ‡¶è‡¶ñ‡¶® ‡¶è‡¶ï‡¶ü‡ßÅ busy üòÖ ‡¶™‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ü‡ßç‡¶∞‡¶æ‡¶á ‡¶ï‡¶∞‡ßã' },
        { status: 500 }
      );
    }

    const data = await response.json();
    const reply = data?.choices?.[0]?.message?.content;

    if (!reply) {
      return NextResponse.json(
        { error: 'AI ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶Ü‡¶∏‡ßá‡¶®‡¶ø' },
        { status: 500 }
      );
    }

    return NextResponse.json({ reply });
  } catch {
    return NextResponse.json(
      { error: '‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶è‡¶ï‡¶ü‡¶æ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá üò¨ ‡¶™‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßã' },
      { status: 500 }
    );
  }
}
